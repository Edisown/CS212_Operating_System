#!/bin/bash
#==================================================
# Script Name   :       check_stock_status
# Purpose       :       Displays products based on stock status (Available or Low).
#==================================================
prods="./res/IPSdataset.txt"
source ./res/my_funcs

# Ask user for the option (Available or Low stock)
echo -e "\n\n\n\n\n"
read -p "$(center_text 'Check [Available] or [Low] Stock products: ')" option

# Initialize temporary files
low="low_stock_temp.txt"
avail="avail_stock_temp.txt"

# Ensure temp files are empty
> "$low"
> "$avail"

# Read the dataset line by line
while IFS=":" read -r pid name categ supp price quan sales max; do
    # Calculate 20% of the max threshold
    twenty_percent=$((max / 5))

    # Determine the status of the product
    if (( quan <= twenty_percent )); then
        status="low"
    else
        status="avail"
    fi

    # Append to appropriate file based on the status
    if [[ "$status" == "low" ]]; then
        echo "$pid:$name:$categ:$supp:$price:$quan:$sales" >> "$low"
    else
        echo "$pid:$name:$categ:$supp:$price:$quan:$sales" >> "$avail"
    fi
done < "$prods"  # Correctly reading from the dataset file

# Clear screen and display the results
clear
center_text "=================================================="
center_text "Product Stock Status"
center_text "=================================================="
echo -e "\n"

if [[ "$option" =~ [Ll]ow ]]; then
    center_text "Low Stock Products"
    center_text "=================================================="
    
    # Use printf to format the headers and pass it directly to center_text
    center_text "$(printf '%-10s%-35s%-15s%-5s\n' 'Product ID' 'Name' 'Category' 'Quantity')"
    
    # Print the data rows, formatting and centering each one
    while IFS=":" read -r pid name categ supp price quan sale; do
        center_text "$(printf '%-30s%-35s%-30s%-30s\n' "$pid" "$name" "$categ" "$quan")"
    done < "$low"
else
    center_text "Available Products"
    center_text "=================================================="
    
    # Use printf to format the headers and pass it directly to center_text
    center_text "$(printf '%-30s%-35s%-30s%-30s\n' 'Product ID' 'Name' 'Category' 'Quantity')"
    center_text "$(printf '%-30s%-35s%-30s%-30s\n' '============' '============' '============' '============')"
    
    # Print the data rows, formatting and centering each one
    while IFS=":" read -r pid name categ supp price quan sale; do
        center_text "$(printf '%-30s%-35s%-30s%-30s\n' "$pid" "$name" "$categ" "$quan")"
    done < "$avail"
fi

# Clean up temporary files
rm "$low" "$avail"
